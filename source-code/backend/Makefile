# ===== Compiler configuration =====

# CC: C compiler
CC          := gcc
# CSTD: C language standard
CSTD        := -std=c11
# WARN: enable useful warnings
WARN        := -Wall -Wextra -Wpedantic
# DEPFLAGS: dependency tracking for smart rebuilds
DEPFLAGS    := -MMD -MP
# DEBUG: debugging information
DEBUG := -g -O0 -fno-omit-frame-pointer

# RELEASE: release settings (-O3 optimization level, disables assert(expr))
RELEASE     := -O3 -DNDEBUG

# CFLAGS: all compiler flags
CFLAGS      := $(CSTD) $(WARN) $(DEPFLAGS) -D_POSIX_C_SOURCE
# LDFLAGS: specifies how to link libraries
LDFLAGS     :=
# LDLIBS: specifies which libraries to import
LDLIBS      := -lm -lsqlite3 -ljson-c


# ===== Directories definition =====

# SRC_DIR: directory of .c source files
SRC_DIR     := src
# OBJ_DIR: directory for compiled .o files
OBJ_DIR     := build
# BIN_DIR: directory for final executable
BIN_DIR     := bin
# INSTALL_DIR: directory where the executable will be installed
INSTALL_DIR := /usr/local/bin

# BIN: path to the final binary
BIN         := $(BIN_DIR)/ls-tris


# ===== Source and Object files =====

# SRC: list of all .c files in SRC_DIR (including subfolders)
SRC := $(shell find $(SRC_DIR) -name '*.c')
# OBJ: matching .o file paths for each .c file
OBJ := $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SRC))
# DEP: list of dependency files generated by -MMD
DEP := $(OBJ:.o=.d)


# ===== Targets =====

# .PHONY: declares non-file targets
.PHONY: all debug release install run clean


# all: default target to build everything in debug mode
all: debug

# debug: appends the debug flags and compiles everything
debug: CFLAGS += $(DEBUG)
debug: $(BIN)

# release: appends the release flags, cleans and compiles everything
release: CFLAGS += $(RELEASE)
release: clean $(BIN)
.NOTPARALLEL: release

# install: copies the executable in the target directory (will be created if not exists) and sets permissions of the executable
install: all
	install -Dm755 $(BIN) $(INSTALL_DIR)/$(notdir $(BIN))

# run: executes the program
run: $(BIN)
	./$(BIN)

# clean: removes OBJ_DIR and BIN_DIR
clean:
	rm -rf $(OBJ_DIR) $(BIN_DIR)


# ===== Build rules =====

# $(BIN): links all .o files into the final binary
$(BIN): $(OBJ)
	@mkdir -p $(BIN_DIR)
	$(CC) $(LDFLAGS) $^ -o $@ $(LDLIBS)

# $(OBJ_DIR)/%.o: compiles each .c file into an .o file
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@


# ===== Dependency tracking =====

# -include $(DEP): includes auto-generated dependency files for incremental builds
-include $(DEP)